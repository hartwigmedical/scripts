#!/usr/bin/env bash

source message_functions || exit 1

get_script="lama_api_get"
classes=(contact-group contract hospitals patient report status statuses tumor-sample reference-sample
queries/consents queries/database-loader queries/patient-reporter queries/registration)

print_usage(){
    script=$(basename "$0")
    echo "---"
    echo "Usage: $script [-j] <class> [<filter-value> <filter-key>]"
    echo "Examples:"
    echo " $script hospitals"
    echo " $script tumor-samples"
    echo " $script reports"
    echo " $script queries/consents"
    echo " $script statuses | grep ACTN01020001"
    echo " $script tumor-sample sample-id/ACTN01020001T"
    echo " $script reference-sample sample-id/ACTN01020001R"
    echo " $script queries/consents sample-id/ACTN01020001T"
    echo "Options:"
    echo "  -j  Output raw api json content instead of TSV table"
    echo "  -t  Use testing/pilot environment as source instead of production"
    echo "Notes:"
    echo "  * Available classes: ${classes[*]}"
    echo "  * Use script ${get_script} instead for all non-interactive use!"
    echo "---"
    exit 1
}

output_json='FALSE'
additional_get_params=""

while getopts ':jt' flag; do
    case "${flag}" in
        j) output_json='TRUE' ;;
        t) additional_get_params="-t";;
        *) print_usage >&2
        exit 1 ;;
    esac
done
class=${*:$OPTIND:1} && shift # obligatory
filter_input=${*:$OPTIND:1} && shift # optional
filter_field=${*:$OPTIND:1} && shift # optional but required if searching by any field other than the "sample-id" of object

if [[ -z "$class" || $1 == "-h" || $1 == "--help" ]]; then
    print_usage >&2
fi

main(){
    contains "${class}" "${classes[@]}" || die "Unknown class '${class}' provided."

    if [[ -n "${filter_field}" ]]; then
        filter_field="${filter_field}"
    else
        filter_field="sample-id"
    fi

    json_result=""
    if [[ -n "${filter_input}" ]]; then
        # shellcheck disable=SC2086
        json_result=$($get_script $additional_get_params "${class}/${filter_field}/${filter_input}") || die "Unable to get result (filter input: ${filter_input})"
    else
        # shellcheck disable=SC2086
        json_result=$($get_script $additional_get_params "${class}") || die "Unable to get result (without filter)"
    fi

    if [[ "${output_json}" == "TRUE" ]]; then
        echo "${json_result}"
        exit 0
    fi

    # make sure json is an array from now on regardless of count
    firstCharacter=${json_result:0:1}
    if [[ ! "${firstCharacter}" == '[' ]]; then
        json_result="[${json_result}]"
    fi

    # print result as table
    if [[ "${class}" == "queries/consents" ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\n" sampleId barcode storeData intUse extUseWoCheck extUseWithCheck
        jq -r '.[] | [.sampleId,
            .barcode,
            .storeDataForReuse,
            .allowInternalUse,
            .allowExternalUseWithoutCheck,
            .allowExternalUseWithCheck
        ] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^contact-group ]]; then
        printf "#%s\t%s\t%s\t%s\n" contractCode hospitalName mainContactName mainContactEmail
        jq -r '.[] | [.contractCode, .hospitalName, .mainContact.name, .mainContact.email] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^contract ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\n" code displayName sampleIdStart type startDate endDate
        jq -r '.[] | [.code, .displayName, .sampleIdStart, .type, .startDate//"N/A", .endDate//"N/A"] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^hospital ]]; then
        printf "#%s\t%s\t%s\n" code name city
        jq -r '.[] | [.code, .name, .city] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^status ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\n" \
        sampleId sampleBarcode isolationBarcodes type isolationStatus prepStatus
        jq -r '.[] | [.sampleId,
            .sampleBarcode,
            (.isolationBarcodes|join(",")),
            .type,
            .isolationStatus,
            .prepStatus
        ] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^tumor-sample ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\t%s\n" sampleId patientId submissionNr samplingDate arrivalHmf contractCode sampleBarcodes
        jq -r '.[] | [.sampleId, .patientId, .submissionNr, .samplingDate, .arrivalHmf, .contractCode, (.sampleBarcodes|join(","))] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^reference-sample ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\n" sampleId patientId submissionNr samplingDate arrivalHmf sampleBarcode
        jq -r '.[] | [.sampleId, .patientId, .submissionNr, .samplingDate, .arrivalHmf, .sampleBarcode] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^patient ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\t%s\n" patientId reportingId tumBarcodes tumSampleIds refBarcodes refSampleIds
        jq -r '.[] | [.patientId,
            .reportingId//"N/A",
            ([.tumorSamples[].sampleId//"N/A"]|join(",")),
            ([.tumorSamples[].sampleBarcode//"N/A"]|join(",")),
            ([.referenceSamples[].sampleId//"N/A"]|join(",")),
            ([.referenceSamples[].sampleBarcode//"N/A"]|join(","))
        ] | @tsv' <<< "${json_result}"
    elif [[ "${class}" =~ ^report ]]; then
        printf "#%s\t%s\t%s\t%s\t%s\n" isolationBarcode sampleId reportDate reportType contractCode
        jq -r '.[] | [.isolationBarcode, .sampleId, .reportDate, .reportType, .contractCode] | @tsv' <<< "${json_result}"
    else
        die "Table format for class ${class} is not supported (use -j before other params to receive JSON format)"
    fi
}

contains(){
    local e match="$1"
    shift
    for e; do [[ "${e}" == "$match" || "${e}s" == "$match" ]] && return 0; done
    return 1
}

main