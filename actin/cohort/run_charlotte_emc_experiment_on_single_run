#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1
source io_functions || exit 1

run_dir=$1 && shift

if [[ -z "${run_dir}" ]]; then
    error "Parameters missing. Exiting."
fi

info "Running EMC experiment for ${run_dir}"
# Sample folder name in data/datasets
sample_services=$(basename ${run_dir})
# Sample name without T
sample_actin=${sample_services%?}

create_actin_cohort_clinical_record_from_doid ${sample_services} ${sample_actin}

pipeline_dir=$(locate_actin_cohort_pipeline_directory ${sample_services})
rm -rf ${pipeline_dir}

info "Copying ${run_dir} to ${pipeline_dir}"
cp -r "${run_dir}" "${pipeline_dir}"
# Copy fake bam_metrics to patient sample folders
# TUM = /data/experiments/kd_actin_cohort/pipelines/sampleName/sampleNameT/bam_metrics/
# REF = /data/experiments/kd_actin_cohort/pipelines/sampleName/sampleNameR/bam_metrics/

echo "${pipeline_dir}/${sample_actin}T/bam_metrics"
echo "${pipeline_dir}/${sample_actin}R/bam_metrics"

cp -r /home/rramnarine/bam_metrics/*.tsv "${pipeline_dir}/${sample_actin}T/bam_metrics"
cp -r /home/rramnarine/bam_metrics/*.tsv "${pipeline_dir}/${sample_actin}R/bam_metrics"
rm -r "${pipeline_dir}/${sample_actin}T/bam_metrics/${sample_actin}T.wgsmetrics"
rm -r "${pipeline_dir}/${sample_actin}R/bam_metrics/${sample_actin}R.wgsmetrics"
mv  "${pipeline_dir}/${sample_actin}T/chord/${sample_actin}T_chord_prediction.txt" "${pipeline_dir}/${sample_actin}T/chord/${sample_actin}T_chord_prediction.tsv"

# Make required chord TSV from TXT
run_orange_research_no_germline ${pipeline_dir}

molecular_dir=$(locate_actin_cohort_molecular_directory ${sample_services})
create_or_cleanup_dir ${molecular_dir}
cp "${pipeline_dir}/orange_no_germline/${sample_services}.orange.json" "${molecular_dir}/"
#rm -rf ${pipeline_dir}

actin_molecular_interpreter_cohort ${sample_services}
load_actin_molecular_cohort ${sample_services}