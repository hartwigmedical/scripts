#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1
source database_functions || exit 1

patient=$1 && shift
#actin_credentials=$1 && shift
#actin_database_name=$1 && shift

patient_json="$(locate_actin_patient_record_directory)/${patient}.clinical.json"
actin_jar="$(locate_cohort_actin_molecularLoaderAPP)"

if [[ -z "${patient_json}" || -z "${actin_jar}" ]]; then
    error "Patient or jar Parameters missing. Exiting."
fi

info "Patient json path location${patient_json}"
info "Actin jar location ${actin_jar}"

credentials=$(gcloud secrets versions access "latest" --secret="mysql-patients-sql-prod-1-writer" --project=hmf-secrets)
user=$(echo "${credentials}" | grep user | cut -d "=" -f2 | tr -d '"')
pwd=$(echo "${credentials}" | grep password | cut -d "=" -f2 | tr -d '"')
host=$(echo "${credentials}" | grep host | cut -d "=" -f2 | tr -d '"')
port=$(echo "${credentials}" | grep port | cut -d "=" -f2 | tr -d '"')
dependencies=$(echo "${credentials}" | grep dependencies | cut -d "=" -f2- | tr -d '"')
database="actinResistanceAnalysis"
url=$(echo "mysql://${host}:${port}/${database}?serverTimezone=CET${dependencies}")

info "Database name ${database}"
info "Database url ${url}"

actin_database_sql="$(locate_actin_database_sql_script)"

info "Building ACTIN db '${database}' with host '${host}' on port '${port}' with user '${user}' with pass '${pwd}'"
mysql --host="${host}" --port="${port}" --user="${user}" --password="${pwd}" \
      --execute="CREATE DATABASE IF NOT EXISTS ${database};"
info "Rebuilding ACTIN db '${database}' with host '${host}' on port '${port}' with user '${user}' with pass '${pwd}' using ${actin_database_sql}"
mysql ${database} --host="${host}" --port="${port}" --user="${user}" --password="${pwd}" < ${actin_database_sql}

info "Done!"

info "Loading $(basename ${patient_json}) into ACTIN database '${database}'"

java -cp ${actin_jar} com.hartwig.actin.database.molecular.MolecularLoaderApplicationKt \
    -patient_json ${patient_json} \
    -db_user ${user} -db_pass ${pwd} -db_url ${url} \
    "$@"
