#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1
source database_functions || exit 1

patient=$1 && shift
#actin_credentials=$1 && shift
#actin_database_name=$1 && shift

patient_json="$(locate_actin_patient_record_directory)/${patient}.clinical.json"
actin_jar="$(locate_cohort_actin_molecularLoaderAPP)"

if [[ -z "${patient_json}" || -z "${actin_jar}" ]]; then
    error "Patient or jar Parameters missing. Exiting."
fi

info "Patient json path location${patient_json}"
info "Actin jar location ${actin_jar}"

credentials=$(gcloud secrets versions access "latest" --secret="mysql-patients-sql-prod-1-writer" --project=hmf-secrets)

info "Credentials ${credentials}"
user=$(echo "${credentials}" | grep user | cut -d "=" -f2 | tr -d '"')
pwd=$(echo "${credentials}" | grep password | cut -d "=" -f2 | tr -d '"')
host=$(echo "${credentials}" | grep host | cut -d "=" -f2 | tr -d '"')
port=$(echo "${credentials}" | grep port | cut -d "=" -f2 | tr -d '"')

info "User: ${user} Password: ${pwd} Host: ${host} Port: ${port}"

database="actinResistanceAnalysis"
info "Database name ${database}"

actin_database_sql="$(locate_actin_database_sql_script)"
info "Rebuilding ACTIN db '${database}' with host '${host}' on port '${port}' with user '${user}' with pass '${pwd}' using ${actin_database_sql}"

mysql ${database} --host="${host}" --port="${port}" --user="${user}" --password="${pass}" < ${actin_database_sql}

info "Done!"

#do_recreate_actin_database ${credentials} ${database}

#info "Loading $(basename ${patient_json}) into ACTIN database '${database}'"

#java -cp ${actin_jar} com.hartwig.actin.database.molecular.MolecularLoaderApplicationKt \
#    -patient_json ${patient_json} \
#    -db_user ${db_user} -db_pass ${db_pass} -db_url ${db_url} \
#    "$@"
