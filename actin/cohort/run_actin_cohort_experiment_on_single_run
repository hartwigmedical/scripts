#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1
source io_functions || exit 1
source lims_functions || exit 1

run_dir=$1 && shift

if [[ -z "${run_dir}" ]]; then
    error "Parameters missing. Exiting."
fi

info "Running ACTIN cohort experiment for ${run_dir}"
tum_sample=$(basename ${run_dir})

create_actin_cohort_clinical_record_from_doid ${tum_sample}

pipeline_dir=$(locate_actin_cohort_pipeline_directory ${tum_sample})

create_or_cleanup_dir ${pipeline_dir}

info "Copying ${run_dir} to ${pipeline_dir}"
cp -r "${run_dir}/." "${pipeline_dir}/"

dummy_metric_dir="/data/experiments/rr_actin_cohort/dummy_metrics"
# RR: Replace wgs metrics with fake bam metrics for tumor
rm -r "${pipeline_dir}/${tum_sample}/bam_metrics/${tum_sample}.wgsmetrics"
cp "${dummy_metric_dir}/dummy.bam_metric.flag_counts.tsv" "${pipeline_dir}/${tum_sample}/bam_metrics/${tumor_sample}.bam_metric.flag_counts.tsv"
cp "${dummy_metric_dir}/dummy.bam_metric.summary.tsv" "${pipeline_dir}/${tum_sample}/bam_metrics/${tumor_sample}.bam_metric.summary.tsv"

# RR: Replace wgs metrics with fake bam metrics for reference
ref_sample=$(imply_ref_sample_from_tumor_sample ${tum_sample})
rm -r "${pipeline_dir}/${ref_sample}/bam_metrics/${ref_sample}.wgsmetrics"
cp "${dummy_metric_dir}/dummy.bam_metric.flag_counts.tsv" "${pipeline_dir}/${ref_sample}/bam_metrics/${ref_sample}.bam_metric.flag_counts.tsv"
cp "${dummy_metric_dir}/dummy.bam_metric.summary.tsv" "${pipeline_dir}/${ref_sample}/bam_metrics/${ref_sample}.bam_metric.summary.tsv"

# RR: Chord output file name modification
mv "${pipeline_dir}/chord/${tum_sample}_chord_prediction.txt" "${pipeline_dir}/chord/${tum_sample}.chord.prediction.tsv"

# RR: Peach output file name modification
mv "${pipeline_dir}/peach/${tum_sample}.peach.genotype.tsv" "${pipeline_dir}/peach/${ref_sample}.peach.haplotypes.best.tsv"

run_orange_research_no_germline ${pipeline_dir}

molecular_dir=$(locate_actin_cohort_molecular_directory ${tum_sample})
create_or_cleanup_dir ${molecular_dir}

cp "${pipeline_dir}/orange_no_germline/${tum_sample}.orange.json" "${molecular_dir}/"
actin_molecular_interpreter_cohort ${tum_sample}
load_actin_molecular_cohort ${tum_sample}