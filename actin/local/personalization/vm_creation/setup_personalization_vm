#!/usr/bin/env bash

source message_functions || exit 1

set -a  
source .env
set +a

suffix=$1 && shift
if [ -z "${suffix}" ]; then
    suffix=$(whoami)
    info "No suffix provided, taking username '$(whoami)'"
fi

vm_name=actin-developer-vm-${suffix}

if [ -z "$(gcloud compute --project actin-research instances list | grep ${vm_name} 2>/dev/null)" ]; then
    error "VM does not exist: ${vm_name}"
fi

# BC: verify all variables are set
: "${SSH_KEY_FILE:?Need to set SSH_KEY_FILE non-empty}"
: "${GIT_NAME:?Need to set GIT_NAME non-empty}"
: "${GIT_EMAIL:?Need to set GIT_EMAIL non-empty}"

# BC: Create ssh config entry
echo "
Host ${vm_name}
    User developer
    AddKeysToAgent yes
    ForwardAgent yes
    IdentityFile ${SSH_KEY_FILE}
    IdentitiesOnly yes
    HostName ${vm_name}
    Port 1215
    ProxyCommand gcloud compute start-iap-tunnel --zone europe-west4-a --project actin-research --listen-on-stdin %h 22
" > ~/.ssh/personalization_vm_config

ssh_config_file=~/.ssh/config

# BC: Ensure ssh config file exists
if [ ! -f ${ssh_config_file} ]; then
    echo "Creating ${ssh_config_file} file"
    touch ${ssh_config_file}
    chmod 600 ${ssh_config_file}
fi

# BC: Remove old entry from known_hosts
sed -i.bak "/${vm_name}/d" ~/.ssh/known_hosts

include_directive="Include ~/.ssh/personalization_vm_config"

if ! head -n 1 ${ssh_config_file} | grep -Fxq "${include_directive}"; then
    { echo "${include_directive}"; cat "${ssh_config_file}"; } > "${ssh_config_file}.tmp" && mv "${ssh_config_file}.tmp" "${ssh_config_file}"
fi

max_tries=10
count=0

while ! gcloud compute ssh developer@${vm_name} \
    --zone=europe-west4-a \
    --project=actin-research \
    --tunnel-through-iap \
    --ssh-key-file=${SSH_KEY_FILE} \
    --command "exit 0" \
    --quiet 2>/tmp/gcloud_ssh.log; do

    count=$((count+1))
    if [ ${count} -ge ${max_tries} ]; then
        cat /tmp/gcloud_ssh.log
        warn "❌ VM is not available after ${max_tries} attempts. Giving up."
        warn "Logs are in /tmp/gcloud_ssh.log"
        exit 1
    fi

    info "Waiting for VM to become available... (attempt ${count}/${max_tries})"
    sleep 5
done
info "✅ VM is available!"

ssh -t -A ${vm_name} "bash -l -c 'gcloud auth login'"

ssh -t -A ${vm_name} << EOF
    git config --global user.name "${GIT_NAME}"
    git config --global user.email "${GIT_EMAIL}"
    ssh-keyscan github.com >> ~/.ssh/known_hosts

    echo "Setting up tools. Note: Use fetch_actin_personalization_jar to populate these the tools"
    mkdir -p /data/tools/actin-personalization
    mkdir -p /data/tools/actin-database-sql
    
    echo "Setting up repos"
    
    mkdir -p /data/repos 
    git clone git@github.com:hartwigmedical/scripts.git /data/repos/scripts/    
    git clone git@github.com:hartwigmedical/actin-personalization.git /data/repos/actin-personalization/
    
    cd /data/repos/actin-personalization
    pre-commit install
    
    echo "Setting up ACTIN private resources repo..."
    gcloud source repos clone actin-resources-private /data/repos/actin-resources-private --project=actin-build

    echo "Setting up training output and resources"
    mkdir -p /data/training_output/resources
    gsutil -m rsync -r gs://actin-personalization-reference-patient-data /data/training_output/resources/
    mkdir -p /data/training_output/models
    gsutil -m rsync -r gs://actin-personalization-models-v1 /data/training_output/models/

    echo "Setting up patient-like-me data"
    mkdir -p /data/patient_like_me/reference_db
    mkdir -p /data/patient_like_me/sources/cairo
    gsutil -m rsync -r gs://hmf-crunch-actin-dccg-dataset/cairo /data/patient_like_me/sources/cairo/
    mkdir -p /data/patient_like_me/sources/ncr
    gsutil -m rsync -r gs://hmf-crunch-actin-ncr-dataset /data/patient_like_me/sources/ncr/
    mkdir -p /data/patient_like_me/sources/orchestra
    gsutil -m rsync -r gs://hmf-crunch-actin-orchestra-dataset /data/patient_like_me/sources/orchestra/
    mkdir -p /data/patient_like_me/sources/palga
    gsutil -m rsync -r gs://hmf-crunch-actin-palga-dataset /data/patient_like_me/sources/palga/

    echo "Creating system-level profile"
    echo 'source /data/repos/scripts/config/bashrc' | sudo tee /etc/profile.d/actin_env.sh
EOF

info "✅ Setup complete! You can now connect to your VM using: ssh ${vm_name}"
warn "Note! You should source /data/repos/scripts/config/bashrc in your .profile to be able to use the scripts properly"
