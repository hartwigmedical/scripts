#!/usr/bin/env bash

source actin_config|| exit 1
source locate_files || exit 1

gcp_project=$1 && shift

if [[ -z "${gcp_project}" ]]; then
    error "Parameters missing. Exiting.";
fi

if [[ "${gcp_project}" == "$(production_actin_emc_project)" ]]; then
    if [[ $# -eq 0 || "$1" == --* ]]; then
        error "Namespace parameter required for '$(production_actin_emc_project)'."
        exit 1
    fi
    namespace=$1
    shift
fi

info "Triggering feed transformation for ${gcp_project} ${namespace}"
clinical_feed_bucket=$(locate_actin_clinical_feed_input_bucket ${gcp_project} ${namespace})
gsutil cp "${clinical_feed_bucket}/upload.complete" "/tmp/"
gsutil cp  "/tmp/upload.complete" ${clinical_feed_bucket}/