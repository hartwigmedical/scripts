#!/usr/bin/env bash

source message_functions || exit 1

isolation_barcode=$1 && shift

[[ -n "${isolation_barcode}" ]] || die "No set name provided. Exiting"

nextcloud_dir="STAGING/New-Reports-Viewing/orange"
bucket="gs://diagnostic-pipeline-output-prod-1"
set=$(api -j runs 'barcode=${isolation_barcode}&ini=Somatic.ini&status=Validated&context=DIAGNOSTIC' | jq .[].set.name | tr -d '"')
tumor_sample_barcode=$(lama_get_patient_reporter_data ${isolation_barcode} | jq .tumorSampleBarcode | tr -d '"')
orange_dir="${bucket}/${set}/orange_no_germline/"

temp_folder_path_file=$( pwd )"/temp_cp_orange_${set}"
mkdir $temp_folder_path_file
gsutil cp -r ${orange_dir}  $temp_folder_path_file/

temp_path_orange=$( pwd )"/temp_cp_orange_${set}/orange_no_germline"
orange_pdf=$( ls $temp_path_orange | grep pdf)

info "Uploading orange data to Nextcloud."
do_upload_files_to_nextcloud_directory "${nextcloud_dir}" "$temp_path_orange/${orange_pdf}"
rm -r $temp_folder_path_file

info "Uploading oncoact report to Nextcloud for viewing"

python3 /data/repos/scripts/oncoact/patientreporter/reporting_pipeline/reports_to_nc.py ${tumor_sample_barcode}