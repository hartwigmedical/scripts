#!/usr/bin/env bash

source metadata_functions || exit 1
source message_functions || exit 1
source locate_files || exit 1
source io_functions || exit 1

run_dir=$1 && shift
cuppa_jar=$1 && shift
cuppa_dir=$1 && shift

if [[ -z "${run_dir}" || -z ${cuppa_jar} || -z "${cuppa_dir}" ]]; then
    error "Missing params. Exiting"
fi

tumor_sample=$(load_tumor_sample_from_metadata ${run_dir})

tmp_sample_data_dir="${run_dir}/cuppa_sample_data_dna"

info "Creating and populating sample data dir '${tmp_sample_data_dir}'"
create_or_cleanup_dir ${tmp_sample_data_dir}
cp -r ${run_dir}/purple/* ${tmp_sample_data_dir}/
cp -r ${run_dir}/linx/* ${tmp_sample_data_dir}/
if [[ -d ${run_dir}/virus_interpreter ]]; then
    cp -r ${run_dir}/virus_interpreter/* ${tmp_sample_data_dir}/
else
    cp -r ${run_dir}/virusintrprtr/* ${tmp_sample_data_dir}/
fi

create_or_cleanup_dir "${cuppa_dir}"

info "Running CuppaDataPrep DNA on ${run_dir}"
java -Xmx4G -cp ${cuppa_jar} com.hartwig.hmftools.cup.prep.CuppaDataPrep \
    -sample ${tumor_sample} \
    -categories "DNA" \
    -ref_genome_version "V37" \
    -sample_data_dir ${tmp_sample_data_dir} \
    -output_dir ${cuppa_dir} \
    "$@"

info "Removing temporary data dir '${tmp_sample_data_dir}'"
rm -r ${tmp_sample_data_dir}

python_version=$(python3 --version)
if [[ "${python_version}" != "Python 3.9.0" ]]; then
    info "Adding python 3.9.0 to PATH"
    export PATH="$HOME/.pyenv/versions/3.9.0/bin:$PATH"
fi

info "Setting up pycuppa venv"
pycuppa_venv="${HOME}/pycuppa_venv"
python3 -m venv ${pycuppa_venv}
source ${pycuppa_venv}/bin/activate

info "Installing pycuppa tool into venv"
pip3 install --upgrade pip
pip3 install /data/experiments/pilot_tools/pycuppa

info "Running pycuppa DNA on ${run_dir}"
python3 -m cuppa.predict \
    --sample_id ${tumor_sample} \
    --features_path "${cuppa_dir}/${tumor_sample}.cuppa_data.tsv.gz" \
    --output_dir "${cuppa_dir}"

info "Generating CUPPA R visualization for ${sample} in ${run_dir}"
Rscript --vanilla /data/experiments/pilot_tools/cuppa_visualizer/plot_predictions.R \
    "${cuppa_dir}/${sample}.cuppa.vis_data.tsv" \
    "${cuppa_dir}/${sample}.cuppa.vis.png"

info "Complete"