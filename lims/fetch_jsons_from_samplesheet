#!/usr/bin/env bash

source message_functions || exit 1
source locate_files || exit 1

usage() {
    echo "---"
    echo " Descr: Fetch run registration jsons for entire samplesheet"
    echo " Usage: $(basename $0) -s <string> -j <string>"
    echo " Exmpl: $(basename $0) -s /path/to/samplesheet -j /path/to/output/jsons"
    echo "---"
    exit 1
}

while getopts ":j:s:h:" opt; do
    case "${opt}" in
        j)
            j=${OPTARG}
            ;;
        s)
            s=${OPTARG}
            ;;
        h)
            usage
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

if [[ -z ${s} || -z ${j} ]]; then
    usage
fi

SHEET_LOC=${s}
JSONS_LOC=${j}

if [[ ! -f ${SHEET_LOC} ]]; then
    die "SampleSheet ${SHEET_LOC} does not exist"
fi

if grep -q -e "Name,NO" -e "Name,IS" ${SHEET_LOC}
then
  start=$(( $(cat ${SHEET_LOC} | grep -n Data] | cut -d: -f1) + 1))
  end=$(cat ${SHEET_LOC} | wc -l)
else
  start=$(( $(cat ${SHEET_LOC} | grep -n BCLConvert_Data] | cut -d: -f1) + 1))
  end=$(cat ${SHEET_LOC} | wc -l)
fi
col_num=$(sed -n -e "${start},${start}p" ${SHEET_LOC} | tr -s ',' '\n' | nl -nln |  grep "Sample_ID" | cut -f1)
barcodes=$(sed -n -e "$((${start} + 1)),${end}p" ${SHEET_LOC} | cut -d',' -f${col_num} | sort | uniq | sed '/^[[:space:]]*$/d' | tr -s '\n' ' ')
for barcode in ${barcodes}; do
    fetch_register_json -b ${barcode} -o ${JSONS_LOC}
done