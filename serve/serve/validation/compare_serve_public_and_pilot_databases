#!/usr/bin/env bash

source message_functions || exit 1
source database_functions || exit 1

credentials=$(prod_writer_sql_credentials)

experiments_dir="/data/experiments/cb_serve_v7_verification";

serve_v6_database="serve_public"
serve_v7_database="serve_pilot"

info "Comparing SERVE v6 database '${serve_v6_database}' with SERVE v7 database '${serve_v7_database}'"

hotspot_query="select gene, chromosome, position, ref, alt, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableHotspot order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25;"
codon_query="select gene, chromosome, start, end, applicableMutationType, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableCodon order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25;"
exon_query="select gene, chromosome, start, end, applicableMutationType, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableExon order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25;"
gene_query="select gene, event, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableGene order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22;"
fusion_query="select geneUp, minExonUp, maxExonUp, geneDown, minExonDown, maxExonDown, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableFusion order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26;"
characteristic_query="select type, cutoffType, cutoff, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableCharacteristic order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23;"
hla_query="select hlaAllele, source, entryDate, sourceEvent, sourceUrls, nctId, title, acronym, genderCriterium, countriesAndCities, hospitalsPerCity, treatment, applicableCancerType, applicableDoid, blacklistCancerTypes, efficacyDescription, evidenceYear, evidenceLevel, evidenceLevelDetails, direction, evidenceUrls from actionableHla order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21;"

do_execute_sql_on_database "${hotspot_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_hotspots.tsv"
do_execute_sql_on_database "${hotspot_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_hotspots.tsv"

do_execute_sql_on_database "${codon_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_codons.tsv"
do_execute_sql_on_database "${codon_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_codons.tsv"

do_execute_sql_on_database "${exon_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_exons.tsv"
do_execute_sql_on_database "${exon_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_exons.tsv"

do_execute_sql_on_database "${gene_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_genes.tsv"
do_execute_sql_on_database "${gene_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_genes.tsv"

do_execute_sql_on_database "${fusion_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_fusions.tsv"
do_execute_sql_on_database "${fusion_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_fusions.tsv"

do_execute_sql_on_database "${characteristic_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_characteristics.tsv"
do_execute_sql_on_database "${characteristic_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_characteristics.tsv"

do_execute_sql_on_database "${hla_query}" "${serve_v6_database}" "${credentials}" > "${experiments_dir}/v6_actionable_hla.tsv"
do_execute_sql_on_database "${hla_query}" "${serve_v7_database}" "${credentials}" > "${experiments_dir}/v7_actionable_hla.tsv"

info "Written output to ${experiments_dir}"

